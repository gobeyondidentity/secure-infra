name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/gobeyondidentity/secureinfra

jobs:
  # Run tests before releasing (self-hosted for speed)
  test:
    runs-on: [self-hosted, linux, x64, fast]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests
        run: go test -v -race ./...

      - name: Run vet
        run: go vet ./...

  # Build CLIs and server binaries (self-hosted for speed)
  goreleaser:
    runs-on: [self-hosted, linux, x64, fast]
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  # Build DPU agent on BlueField self-hosted runner
  dpu-agent:
    runs-on: [self-hosted, dpu-arm64]
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build dpu-agent with DOCA
        run: |
          export PATH=/usr/local/go/bin:$PATH
          export CGO_ENABLED=1
          go build -tags doca \
            -ldflags "-s -w -X github.com/gobeyondidentity/secure-infra/internal/version.Version=${{ steps.version.outputs.VERSION }}" \
            -o dpu-agent ./cmd/agent

      - name: Generate checksum
        run: sha256sum dpu-agent > dpu-agent_linux_arm64.sha256

      - name: Create tarball
        run: tar -czvf dpu-agent_linux_arm64.tar.gz dpu-agent

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dpu-agent_linux_arm64.tar.gz
            dpu-agent_linux_arm64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and push container images
  docker:
    runs-on: ubuntu-latest
    needs: [test]
    strategy:
      matrix:
        include:
          - image: host-agent
            dockerfile: Dockerfile.host-agent
            platforms: linux/amd64,linux/arm64
          - image: control-plane
            dockerfile: Dockerfile.control-plane
            platforms: linux/amd64,linux/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: ${{ matrix.platforms }}
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-${{ matrix.image }}:${{ steps.version.outputs.VERSION }}
            ${{ env.IMAGE_PREFIX }}-${{ matrix.image }}:latest

  # Add upgrade instructions to release notes
  release-notes:
    runs-on: ubuntu-latest
    needs: [goreleaser, dpu-agent, docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Append upgrade instructions
        uses: softprops/action-gh-release@v2
        with:
          append_body: true
          body: |

            ---

            ## Upgrade Instructions

            ### CLI Tools (Homebrew)
            ```bash
            brew upgrade nmelo/tap/bluectl
            brew upgrade nmelo/tap/km
            ```

            ### CLI Tools (Direct Download)
            Download the appropriate binary for your platform from the assets below, then:
            ```bash
            chmod +x bluectl km
            sudo mv bluectl km /usr/local/bin/
            ```

            ### Container Images
            ```bash
            docker pull ghcr.io/gobeyondidentity/secureinfra-host-agent:${{ steps.version.outputs.VERSION }}
            docker pull ghcr.io/gobeyondidentity/secureinfra-control-plane:${{ steps.version.outputs.VERSION }}
            ```

            ### DPU Agent
            Download `dpu-agent_linux_arm64.tar.gz`, then on the BlueField:
            ```bash
            tar -xzf dpu-agent_linux_arm64.tar.gz
            sudo mv dpu-agent /usr/local/bin/
            sudo systemctl restart dpu-agent  # if running as service
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Final verification
  verify-release:
    runs-on: ubuntu-latest
    needs: [goreleaser, dpu-agent, docker, release-notes]
    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify release artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying release v${{ steps.version.outputs.VERSION }}..."

          # Check CLI binaries
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "bluectl_darwin_arm64.tar.gz" && echo "✓ bluectl darwin/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "km_darwin_arm64.tar.gz" && echo "✓ km darwin/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "dpu-agent_linux_arm64.tar.gz" && echo "✓ dpu-agent linux/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "checksums.txt" && echo "✓ checksums"

          echo ""
          echo "Release v${{ steps.version.outputs.VERSION }} verified successfully!"
