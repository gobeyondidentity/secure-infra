name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_REGISTRY: ghcr.io/gobeyondidentity
  CLOUDSMITH_ORG: beyond-identity
  CLOUDSMITH_REPO: secure-infra

jobs:
  # Run tests before releasing (self-hosted for speed)
  test:
    runs-on: [self-hosted, linux, x64, fast]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tests
        run: go test -v -race ./...

      - name: Run vet
        run: go vet ./...

  # Build CLIs and server binaries (self-hosted for speed)
  goreleaser:
    runs-on: [self-hosted, linux, x64, fast]
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean up draft releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete any existing draft releases for this tag (prevents duplicates on retries)
          TAG=${GITHUB_REF#refs/tags/}
          gh api repos/${{ github.repository }}/releases --jq ".[] | select(.tag_name == \"$TAG\" and .draft == true) | .id" | \
            xargs -I {} gh api -X DELETE repos/${{ github.repository }}/releases/{}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  # Push Linux packages to Cloudsmith (parallel by component)
  cloudsmith-push:
    runs-on: ubuntu-latest
    needs: [goreleaser]
    strategy:
      matrix:
        component: [bluectl, km, sentry, nexus]
    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Cloudsmith CLI
        run: pip install cloudsmith-cli

      - name: Download ${{ matrix.component }} packages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "v${{ steps.version.outputs.VERSION }}" \
            --repo ${{ github.repository }} \
            --pattern "${{ matrix.component }}_*.deb" \
            --pattern "${{ matrix.component }}_*.rpm" \
            --pattern "${{ matrix.component }}-*.rpm" \
            --dir packages/

      - name: Push ${{ matrix.component }} to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          for pkg in packages/*.deb; do
            [ -f "$pkg" ] && cloudsmith push deb --republish ${{ env.CLOUDSMITH_ORG }}/${{ env.CLOUDSMITH_REPO }}/any-distro/any-version "$pkg"
          done
          for pkg in packages/*.rpm; do
            [ -f "$pkg" ] && cloudsmith push rpm --republish ${{ env.CLOUDSMITH_ORG }}/${{ env.CLOUDSMITH_REPO }}/any-distro/any-version "$pkg"
          done

  # Build DPU agent on BlueField self-hosted runner
  # Runs after goreleaser to avoid race conditions on GitHub release uploads
  dpu-agent:
    runs-on: [self-hosted, dpu-arm64]
    needs: [goreleaser]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build dpu-agent with DOCA
        run: |
          export PATH=/usr/local/go/bin:$PATH
          export CGO_ENABLED=1
          go build -tags doca \
            -ldflags "-s -w -X github.com/gobeyondidentity/secure-infra/internal/version.Version=${{ steps.version.outputs.VERSION }}" \
            -o dpu-agent ./cmd/agent

      - name: Generate checksum
        run: sha256sum dpu-agent > dpu-agent_linux_arm64.sha256

      - name: Create tarball
        run: tar -czvf dpu-agent_linux_arm64.tar.gz dpu-agent

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update && sudo apt-get install -y gh

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ steps.version.outputs.VERSION }}" \
            dpu-agent_linux_arm64.tar.gz \
            dpu-agent_linux_arm64.sha256 \
            --clobber

      - name: Copy DOCA runtime libraries
        run: |
          mkdir -p doca-libs
          cp /opt/mellanox/doca/lib/aarch64-linux-gnu/libdoca_comch.so* doca-libs/
          cp /opt/mellanox/doca/lib/aarch64-linux-gnu/libdoca_common.so* doca-libs/

      - name: Build Linux packages
        run: |
          export VERSION=${{ steps.version.outputs.VERSION }}
          nfpm package -p deb -f packaging/nfpm-dpu-agent.yaml
          nfpm package -p rpm -f packaging/nfpm-dpu-agent.yaml

      - name: Upload packages to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ steps.version.outputs.VERSION }}" \
            aegis_*.deb \
            aegis-*.rpm \
            --clobber

      - name: Push packages to Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          pip install --break-system-packages cloudsmith-cli
          export PATH="$HOME/.local/bin:$PATH"
          for pkg in aegis_*.deb; do
            cloudsmith push deb --republish ${{ env.CLOUDSMITH_ORG }}/${{ env.CLOUDSMITH_REPO }}/any-distro/any-version "$pkg"
          done
          for pkg in aegis-*.rpm; do
            cloudsmith push rpm --republish ${{ env.CLOUDSMITH_ORG }}/${{ env.CLOUDSMITH_REPO }}/any-distro/any-version "$pkg"
          done

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push container image
        run: |
          docker build -f Dockerfile.dpu-agent -t ${{ env.IMAGE_REGISTRY }}/aegis:${{ steps.version.outputs.VERSION }} .
          docker push ${{ env.IMAGE_REGISTRY }}/aegis:${{ steps.version.outputs.VERSION }}
          docker tag ${{ env.IMAGE_REGISTRY }}/aegis:${{ steps.version.outputs.VERSION }} ${{ env.IMAGE_REGISTRY }}/aegis:latest
          docker push ${{ env.IMAGE_REGISTRY }}/aegis:latest

  # Build amd64 container images (native on workbench-linux)
  docker-amd64:
    runs-on: [self-hosted, linux, x64, fast]
    needs: [test]
    strategy:
      matrix:
        include:
          - image: sentry
            dockerfile: Dockerfile.host-agent
          - image: nexus
            dockerfile: Dockerfile.control-plane
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push amd64 image
        run: |
          docker build --provenance=false -f ${{ matrix.dockerfile }} -t ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-amd64 .
          docker push ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-amd64

  # Build arm64 container images (native on spark-1)
  docker-arm64:
    runs-on: [self-hosted, linux, arm64, fast]
    needs: [test]
    strategy:
      matrix:
        include:
          - image: sentry
            dockerfile: Dockerfile.host-agent
          - image: nexus
            dockerfile: Dockerfile.control-plane
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push arm64 image
        run: |
          docker build --provenance=false -f ${{ matrix.dockerfile }} -t ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-arm64 .
          docker push ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-arm64

  # Create multi-arch manifests from native images
  docker-manifest:
    runs-on: ubuntu-latest
    needs: [docker-amd64, docker-arm64]
    strategy:
      matrix:
        image: [sentry, nexus]
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create and push multi-arch manifest
        run: |
          # Create versioned manifest
          docker manifest create ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }} \
            ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-amd64 \
            ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-arm64
          docker manifest push ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}

          # Create latest manifest
          docker manifest create ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:latest \
            ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-amd64 \
            ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:${{ steps.version.outputs.VERSION }}-arm64
          docker manifest push ${{ env.IMAGE_REGISTRY }}/${{ matrix.image }}:latest

  # Add upgrade instructions to release notes
  release-notes:
    runs-on: ubuntu-latest
    needs: [goreleaser, dpu-agent, docker-manifest, cloudsmith-push]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Append upgrade instructions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current release body
          CURRENT_BODY=$(gh release view "v${{ steps.version.outputs.VERSION }}" --json body --jq '.body')

          # Append upgrade instructions
          gh release edit "v${{ steps.version.outputs.VERSION }}" --notes "$(cat <<NOTES
          ${CURRENT_BODY}

          ---

          ## Upgrade Instructions

          ### CLI Tools (Homebrew)
          \`\`\`bash
          brew upgrade nmelo/tap/bluectl
          brew upgrade nmelo/tap/km
          \`\`\`

          ### CLI Tools (Debian/Ubuntu)
          \`\`\`bash
          # Add repository (auto-detects your distro)
          curl -1sLf 'https://dl.cloudsmith.io/public/beyond-identity/secure-infra/cfg/setup/bash.deb.sh' | sudo bash
          sudo apt update && sudo apt install bluectl km
          \`\`\`

          ### CLI Tools (RHEL/Fedora)
          \`\`\`bash
          # Add repository (auto-detects your distro)
          curl -1sLf 'https://dl.cloudsmith.io/public/beyond-identity/secure-infra/cfg/setup/bash.rpm.sh' | sudo bash
          sudo yum install bluectl km
          \`\`\`

          ### CLI Tools (Direct Download)
          Download the appropriate binary for your platform from the assets below, then:
          \`\`\`bash
          chmod +x bluectl km
          sudo mv bluectl km /usr/local/bin/
          \`\`\`

          ### Sentry (Host Agent)
          \`\`\`bash
          sudo apt update && sudo apt install sentry
          # Configure in /etc/secureinfra/sentry.yaml, then:
          sudo systemctl enable --now sentry
          \`\`\`

          ### Nexus (Control Plane)
          \`\`\`bash
          sudo apt update && sudo apt install nexus
          # Configure in /etc/secureinfra/nexus.yaml, then:
          sudo systemctl enable --now nexus
          \`\`\`

          ### Container Images
          \`\`\`bash
          docker pull ghcr.io/gobeyondidentity/sentry:${{ steps.version.outputs.VERSION }}
          docker pull ghcr.io/gobeyondidentity/nexus:${{ steps.version.outputs.VERSION }}
          \`\`\`

          ### Aegis (DPU Agent) - Binary
          Download \`dpu-agent_linux_arm64.tar.gz\`, then on the BlueField:
          \`\`\`bash
          tar -xzf dpu-agent_linux_arm64.tar.gz
          sudo mv dpu-agent /usr/local/bin/aegis
          sudo systemctl restart aegis  # if running as service
          \`\`\`

          ### Aegis (DPU Agent) - Package
          \`\`\`bash
          sudo apt install aegis  # or: sudo yum install aegis
          sudo systemctl enable --now aegis
          \`\`\`

          ### Aegis (DPU Agent) - Container
          \`\`\`bash
          docker pull ghcr.io/gobeyondidentity/aegis:${{ steps.version.outputs.VERSION }}
          \`\`\`
          NOTES
          )"

  # Final verification
  verify-release:
    runs-on: ubuntu-latest
    needs: [goreleaser, dpu-agent, docker-manifest, cloudsmith-push, release-notes]
    steps:
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify release artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Verifying release v${{ steps.version.outputs.VERSION }}..."

          # Check CLI binaries
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "bluectl_darwin_arm64.tar.gz" && echo "✓ bluectl darwin/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "km_darwin_arm64.tar.gz" && echo "✓ km darwin/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "dpu-agent_linux_arm64.tar.gz" && echo "✓ dpu-agent linux/arm64"
          gh release view "v${{ steps.version.outputs.VERSION }}" --repo ${{ github.repository }} --json assets --jq '.assets[].name' | grep -q "checksums.txt" && echo "✓ checksums"

          echo ""
          echo "Release v${{ steps.version.outputs.VERSION }} verified successfully!"
