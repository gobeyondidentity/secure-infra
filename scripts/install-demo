#!/usr/bin/env bash
#
# Installation Demo Script
# Shows how to install Secure Infrastructure components via Homebrew
#
# Same visual style as the main demo - designed for walkthroughs and presentations.
#

set -e

# ============================================================================
# Colors and Styling
# ============================================================================

CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
WHITE='\033[0;37m'
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'

BG_GREEN='\033[42;30m'
BG_BLUE='\033[44;37m'

# ============================================================================
# Helper Functions
# ============================================================================

print_banner() {
    clear
    echo ""
    echo -e "${BOLD}${CYAN}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘                                                                â•‘"
    echo "  â•‘      Secure Infrastructure Installation                        â•‘"
    echo "  â•‘      From zero to running in under 5 minutes.                  â•‘"
    echo "  â•‘                                                                â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${RESET}"
    echo ""
}

print_step() {
    local emoji="$1"
    local title="$2"
    clear
    echo ""
    echo -e "${BOLD}${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo -e "${BOLD}${emoji} ${title}${RESET}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
}

print_narrative() {
    echo -e "${DIM}$1${RESET}"
    echo ""
}

print_why() {
    echo ""
    echo -e "${YELLOW}WHY THIS MATTERS:${RESET}"
    shift
    for point in "$@"; do
        echo -e "  ${DIM}â€¢${RESET} $point"
    done
    echo ""
}

print_comment() {
    echo -e "${CYAN}# $1${RESET}"
}

print_command() {
    echo -e "${BOLD}> $1${RESET}"
}

print_success() {
    echo -e "${GREEN}$1${RESET}"
}

print_error() {
    echo -e "${RED}$1${RESET}"
}

print_highlight() {
    echo -e "${BG_BLUE} $1 ${RESET}"
}

print_success_highlight() {
    echo -e "${BG_GREEN} $1 ${RESET}"
}

run_command() {
    local comment="$1"
    local cmd="$2"
    echo ""
    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    print_comment "$comment"
    print_command "$cmd"
    echo ""
    echo -en "${GREEN}"
    eval "$cmd" 2>&1 || true
    echo -e "${RESET}"
    echo ""
}

wait_for_key() {
    echo ""
    echo -e "${DIM}Press ENTER to continue (Ctrl+C to exit)...${RESET}"
    read -r || true
}

# ============================================================================
# Installation Steps
# ============================================================================

step_intro() {
    print_banner

    echo -e "This walkthrough installs ${BOLD}Secure Infrastructure${RESET} via Homebrew."
    echo ""
    echo "You'll install:"
    echo -e "  ğŸ“¦ Homebrew tap (package source)"
    echo -e "  ğŸ–¥ï¸  bluectl - Admin CLI for fleet management"
    echo -e "  ğŸ”‘ km (KeyMaker) - Operator CLI for credentials"
    echo -e "  ğŸš€ nexus - Control plane server"
    echo -e "  ğŸ® dpuemu - DPU emulator for testing"
    echo ""
    echo -e "${DIM}Total install time: ~2 minutes${RESET}"
    echo ""

    wait_for_key
}

step_prereqs() {
    print_step "âœ…" "Checking Prerequisites"

    print_narrative "Verifying Homebrew is installed..."

    if command -v brew >/dev/null 2>&1; then
        echo ""
        echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
        print_comment "Check Homebrew version..."
        print_command "brew --version"
        echo ""
        brew --version | head -1
        echo ""
        print_success "Homebrew is installed"
    else
        print_error "Homebrew not found"
        echo ""
        echo "Install Homebrew first:"
        echo ""
        print_comment "Install Homebrew..."
        print_command '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
        echo ""
        exit 1
    fi

    print_why \
        "Homebrew handles dependencies automatically" \
        "One-command updates when new versions release" \
        "Works on macOS and Linux"

    wait_for_key
}

step_tap() {
    print_step "ğŸ“¦" "Adding the Homebrew Tap"

    print_narrative "A tap is a third-party package source. This adds our formulas to Homebrew..."

    run_command "Add the package source..." "brew tap nmelo/tap"

    print_why \
        "Taps let you install software not in the main Homebrew repo" \
        "Once added, updates come through normal 'brew upgrade'" \
        "You only need to do this once per machine"

    wait_for_key
}

step_bluectl() {
    print_step "ğŸ–¥ï¸" "Installing bluectl (Admin CLI)"

    print_narrative "bluectl is the admin tool for managing tenants, DPUs, and operators..."

    run_command "Install bluectl..." "brew install nmelo/tap/bluectl"

    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    print_comment "Verify installation..."
    print_command "bluectl version"
    echo ""
    bluectl version 2>/dev/null || echo "(will show version after install)"
    echo ""

    print_why \
        "Admins use bluectl to set up the infrastructure" \
        "Register DPUs, create tenants, invite operators" \
        "One CLI for all fleet management tasks"

    wait_for_key
}

step_km() {
    print_step "ğŸ”‘" "Installing km (KeyMaker CLI)"

    print_narrative "km is the operator tool for managing credentials and certificates..."

    run_command "Install km..." "brew install nmelo/tap/km"

    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    print_comment "Verify installation..."
    print_command "km version"
    echo ""
    km version 2>/dev/null || echo "(will show version after install)"
    echo ""

    print_why \
        "Operators use km to distribute credentials" \
        "Create SSH CAs, sign certificates, push to fleet" \
        "Separation of duties: admins configure, operators distribute"

    wait_for_key
}

step_nexus() {
    print_step "ğŸš€" "Installing nexus (Control Plane)"

    print_narrative "nexus is the server that coordinates everything..."

    run_command "Install nexus..." "brew install nmelo/tap/nexus"

    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    print_comment "Verify installation..."
    print_command "nexus --help | head -5"
    echo ""
    nexus --help 2>&1 | head -5 || echo "(will show help after install)"
    echo ""

    print_why \
        "Central control plane for policy and coordination" \
        "Runs on your infrastructure, not ours" \
        "Stateless design - easy to run multiple instances"

    wait_for_key
}

step_dpuemu() {
    print_step "ğŸ®" "Installing dpuemu (DPU Emulator)"

    print_narrative "dpuemu simulates a BlueField DPU for development and testing..."

    run_command "Install dpuemu..." "brew install nmelo/tap/dpuemu"

    echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${RESET}"
    print_comment "Verify installation..."
    print_command "dpuemu --help | head -5"
    echo ""
    dpuemu --help 2>&1 | head -5 || echo "(will show help after install)"
    echo ""

    print_why \
        "Test the full workflow without hardware" \
        "Reproducible demos that work anywhere" \
        "Same APIs as real BlueField DPUs"

    wait_for_key
}

step_verify() {
    print_step "ğŸ”" "Verifying Installation"

    print_narrative "Checking all components are installed and accessible..."

    local all_good=true

    echo -e "  Checking bluectl... \c"
    if command -v bluectl >/dev/null 2>&1; then
        print_success "OK"
    else
        print_error "NOT FOUND"
        all_good=false
    fi

    echo -e "  Checking km... \c"
    if command -v km >/dev/null 2>&1; then
        print_success "OK"
    else
        print_error "NOT FOUND"
        all_good=false
    fi

    echo -e "  Checking nexus... \c"
    if command -v nexus >/dev/null 2>&1; then
        print_success "OK"
    else
        print_error "NOT FOUND"
        all_good=false
    fi

    echo -e "  Checking dpuemu... \c"
    if command -v dpuemu >/dev/null 2>&1; then
        print_success "OK"
    else
        print_error "NOT FOUND"
        all_good=false
    fi

    echo ""

    if [[ "$all_good" == "true" ]]; then
        print_success_highlight " ALL COMPONENTS INSTALLED SUCCESSFULLY "
    else
        print_error "Some components failed to install. Check brew output above."
    fi

    wait_for_key
}

step_summary() {
    print_step "ğŸ¯" "Installation Complete"

    echo -e "${GREEN}  âœ… Homebrew tap added${RESET}"
    echo -e "${GREEN}  âœ… bluectl installed (admin CLI)${RESET}"
    echo -e "${GREEN}  âœ… km installed (operator CLI)${RESET}"
    echo -e "${GREEN}  âœ… nexus installed (control plane)${RESET}"
    echo -e "${GREEN}  âœ… dpuemu installed (DPU emulator)${RESET}"
    echo ""

    echo -e "${BOLD}Next steps:${RESET}"
    echo ""
    echo -e "  ${CYAN}1.${RESET} Run the demo:        ${BOLD}./scripts/demo${RESET}"
    echo -e "  ${CYAN}2.${RESET} Read the quickstart: ${BOLD}docs/guides/quickstart-emulator.md${RESET}"
    echo -e "  ${CYAN}3.${RESET} Deploy to hardware:  ${BOLD}docs/guides/setup-hardware.md${RESET}"
    echo ""

    echo -e "${BOLD}${CYAN}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘                                                                â•‘"
    echo "  â•‘     Ready to manage credentials at scale.                      â•‘"
    echo "  â•‘                                                                â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${RESET}"
    echo ""

    echo -e "${DIM}Press ENTER to exit.${RESET}"
    read -r
}

# ============================================================================
# Main
# ============================================================================

main() {
    step_intro
    step_prereqs
    step_tap
    step_bluectl
    step_km
    step_nexus
    step_dpuemu
    step_verify
    step_summary
}

main "$@"
